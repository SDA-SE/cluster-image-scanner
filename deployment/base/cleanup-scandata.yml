apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: cleanup-enforced-delete-pvc-wf-scandata
  namespace: clusterscanner
spec:
  schedule: "0 0 * * *"
  concurrencyPolicy: "Forbid"
  startingDeadlineSeconds: 0
  timezone: Europe/Berlin
  activeDeadlineSeconds: 3600
  workflowSpec:
    artifactRepositoryRef:
      configMap: artifact-repositories
      key: default-v1
    entrypoint: pvc-cleanup
    templates:
      - name: pvc-cleanup
        volumes:
          - name: scandata
            persistentVolumeClaim:
              claimName: cluster-image-scanner-scandata
        script:
          securityContext:
            runAsNonRoot: false
            runAsUser: 0
          image: quay.io/sdase/cluster-image-scanner-base:2
          volumeMounts:
            - name: scandata
              mountPath: /clusterscanner/data
          imagePullPolicy: IfNotPresent
          command: [python3]
          source: |
            import os
            import time
            import shutil
            KEEP_DAYS=7
            for root, dirs, files in os.walk('/clusterscanner/data'):
                if 'manifest.json' in files:
                   if time.time() - os.path.getatime(root) > KEEP_DAYS * 24 * 60 * 60:
                        print(f"Directory {root} has been changed  more than {KEEP_DAYS} days ago. Deleting.")
                        shutil.rmtree(root)
