#!/bin/bash
set -e

if [ $# -ne 7 ]; then
  echo "Parameters are not set correctly"
  exit 1
fi

REGISTRY=$1
ORGANIZATION=$2
IMAGE_NAME=$3
VERSION=$4
REGISTRY_USER=$5
REGISTRY_TOKEN=$6
BUILD_EXPORT_OCI_ARCHIVES=$7

MAJOR=$(echo "${VERSION}" | tr  '.' "\n" | sed -n 1p)
MINOR=$(echo "${VERSION}" | tr  '.' "\n" | sed -n 2p)

oci_prefix="org.opencontainers.image"
descr="Check for malware in images"

trap cleanup INT EXIT
cleanup() {
  test -n "${ctr}" && buildah rm "${ctr}" || true
  test -n "${ctr_tools}" && buildah rm "${ctr_tools}" || true
}

dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
build_dir="${dir}/build"

base_image="quay.io/sdase/cluster-image-scanner-base:2"
ctr="$( buildah from --pull --quiet "${base_image}")"
mnt="$( buildah mount "${ctr}" )"

base_image="registry.access.redhat.com/ubi8/ubi-init" # minimal doesn't have useradd
ctr_tools="$( buildah from --pull --quiet "${base_image}")"
mnt_tools="$( buildah mount "${ctr_tools}")"

dnf_opts=(
  #"--disableplugin=*"
  "--installroot=/mnt"
  "--assumeyes"
  "--setopt=install_weak_deps=false"
  "--releasever=8"
  "--setopt=tsflags=nocontexts,nodocs"
  "--quiet"
)

curl -o ${mnt}/epel.rpm -s -L https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
buildah run --volume "${mnt}":/mnt "${ctr_tools}" -- cp -a /etc/yum.repos.d/ /mnt/etc/
buildah run --volume "${mnt}":/mnt "${ctr_tools}" -- /usr/bin/dnf "${dnf_opts[@]}" install /mnt/epel.rpm
buildah run --volume "${mnt}":/mnt "${ctr_tools}" -- /usr/bin/dnf "${dnf_opts[@]}" update
#buildah run --volume "${mnt}":/mnt "${ctr_tools}" -- cp -a /etc/pki/ /mnt/etc/
#buildah run --volume "${mnt}":/mnt "${ctr_tools}" -- /usr/bin/dnf "${dnf_opts[@]}" --help # --import RPM-GPG-KEY-EPEL-8
buildah run --user 0:0  --volume "${mnt}":/mnt "${ctr_tools}" --  rpm --root "/mnt" --import "/mnt/etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-8"
buildah run --user 0:0  --volume "${mnt}":/mnt "${ctr_tools}" -- /usr/bin/dnf "${dnf_opts[@]}" --nogpgcheck install clamav clamd clamav-update  clamav-unofficial-sigs # TODO gpg check

echo "Update malware DB"
buildah run  --user 0:0 "${ctr}" -- ls -la /etc
buildah run  --user 0:0 "${ctr}" -- chmod +r /etc/freshclam.conf
buildah run  --user 0:0 "${ctr}" --  sed -i '/^Example$/d' /etc/clamd.d/scan.conf
echo "ScanArchive yes" >> "${mnt}/etc/clamd.d/scan.conf"
echo "AlertEncryptedArchive yes" >> "${mnt}/etc/clamd.d/scan.conf"

buildah run --user 0:0 "${ctr}" -- /usr/sbin/clamav-unofficial-sigs.sh --force
buildah run --user 0:0 "${ctr}" --  /usr/bin/freshclam --quiet

echo "adding ClusterImageScanner specifics"
cp module.bash "${mnt}/clusterscanner/"
cp env.bash "${mnt}/clusterscanner/"
cp ../ddTemplate.json "${mnt}/clusterscanner/malware.json"
echo $(jq \
  --arg severity "Critical" \
  '.findings[].severity = $severity' \
  "${mnt}/clusterscanner/malware.json") > "${mnt}/clusterscanner/malware.json"
echo $(jq \
  --arg title "Malware found" \
  '.findings[].title = $title' \
  "${mnt}/clusterscanner/malware.json") > "${mnt}/clusterscanner/malware.json"

../parseMarkdownToCreateDefectDojoText.bash ../../../docs/user/scans/malware.md Relevance "${mnt}/clusterscanner/malware.json"
../parseMarkdownToCreateDefectDojoText.bash ../../../docs/user/scans/malware.md Response "${mnt}/clusterscanner/malware.json"

# Get a bill of materials
base_bill_of_materials_hash=$(buildah inspect --type image "${base_image}"  | jq '.OCIv1.config.Labels."io.sda-se.image.bill-of-materials-hash"')
#echo "base_bill_of_materials_hash $base_bill_of_materials_hash"
bill_of_materials_hash="$( ( cat "${0}";
  echo "${base_bill_of_materials_hash}"; \
  cat ./*; \
  ) | sha256sum | awk '{ print $1 }' )"
echo "bill_of_materials: $bill_of_materials_hash";
buildah config \
  --label "${oci_prefix}.url=https://quay.io/sdase/cluster-image-scanner-scan-malware" \
  --label "${oci_prefix}.source=https://github.com/SDA-SE/clusterscanner-scan-malware" \
  --label "${oci_prefix}.revision=$( git rev-parse HEAD )" \
  --label "${oci_prefix}.version=${VERSION}" \
  --label "${oci_prefix}.title=ClusterImageScanner Malware Scan" \
  --label "${oci_prefix}.description=${descr}" \
  --label "io.sda-se.image.bill-of-materials-hash=${bill_of_materials_hash}" \
  --env 'RESULT_CACHING_HOURS=168' \
  "${ctr}"

buildah commit --quiet "${ctr}" "${IMAGE_NAME}:${VERSION}" && ctr=

if [ -n "${BUILD_EXPORT_OCI_ARCHIVES}" ]
then
  mkdir --parent "${build_dir}"
  image="docker://${REGISTRY}/${ORGANIZATION}/${IMAGE_NAME}:${VERSION}"
  buildah push --quiet --creds "${REGISTRY_USER}:${REGISTRY_TOKEN}" "${IMAGE_NAME}:${VERSION}" "${image}"

  image="docker://${REGISTRY}/${ORGANIZATION}/${IMAGE_NAME}:${MAJOR}.${MINOR}"
  buildah push --quiet --creds "${REGISTRY_USER}:${REGISTRY_TOKEN}" "${IMAGE_NAME}:${VERSION}" "${image}"

  image="docker://${REGISTRY}/${ORGANIZATION}/${IMAGE_NAME}:${MAJOR}"
  buildah push --quiet --creds "${REGISTRY_USER}:${REGISTRY_TOKEN}" "${IMAGE_NAME}:${VERSION}" "${image}"

  buildah rmi "${IMAGE_NAME}:${VERSION}"
fi

cleanup
