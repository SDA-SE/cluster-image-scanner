#!/bin/bash

set -e
# checks if an image a new images exists

source ./unpack.bash
source ./scan-common.bash

scan_result_pre

echo "Scanning ${IMAGE_BY_HASH} ${IMAGE} in ${IMAGE_UNPACKED_DIRECTORY}"
LOGFILE="${ARTIFACTS_PATH}/clamav.log"

if [[ -p "${IMAGE_UNPACKED_DIRECTORY}/run/initctl" ]]; then
  rm -rf "${IMAGE_UNPACKED_DIRECTORY}/run/initctl"
fi

set +e
clamscan --infected --recursive --log="${LOGFILE}" "${IMAGE_UNPACKED_DIRECTORY}"
CLAM_RETURN_CODE=$?
set -e

if [ ${CLAM_RETURN_CODE} -eq 0 ]; then
  echo "${CLAM_RETURN_CODE} -eq 0"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"completed\", \"finding\": false}")
elif [ ${CLAM_RETURN_CODE} -eq 1 ]; then
  findings=$(cat ${LOGFILE} | grep FOUND | sed "s#${IMAGE_UNPACKED_DIRECTORY}##")
  infoText="Potential malware found in ${IMAGE_BY_HASH}\nPlease take a look at ${findings}"
  echo "${infoText}"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"completed\", \"finding\": true, \"infoText\": \"${infoText}\"}")

  cp /clusterscanner/ddTemplate.csv "${ARTIFACTS_PATH}/malware.csv"
  sed -i "s/###SEVERITY###/Low/" "${ARTIFACTS_PATH}/malware.csv" # TODO For test mode low, later critical
  sanitizedInfoText=$(echo ${infoText} | tr -d '|')
  sed -i "s|###INFOTEXT###|${sanitizedInfoText}|" "${ARTIFACTS_PATH}/malware.csv"
else
  infoText="Malware exited with the unexpected code ${CLAM_RETURN_CODE} in ${IMAGE_BY_HASH}, log: ${LOGFILE}"
  echo "${infoText}"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"failed\", \"infoText\": \"${infoText}\"}")
fi

scan_result_post

if [ ${CLAM_RETURN_CODE} -eq 2 ]; then
  exit 2
fi
exit 0

