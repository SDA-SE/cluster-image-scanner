#!/bin/bash

set -e
# checks if an image a new images exists

source ./scan-common.bash

scan_result_pre

echo "Scanning ${IMAGE_BY_HASH} ${IMAGE} in ${IMAGE_TAR_PATH}"
LOGFILE="${ARTIFACTS_PATH}/clamav-$(date +%s).log"

set +e
clamscan --infected --recursive --log="${LOGFILE}" "${IMAGE_TAR_PATH}"
#cat "${LOGFILE}"
CLAM_RETURN_CODE=$?
set -e

if [ ${CLAM_RETURN_CODE} -eq 0 ]; then
  echo "JSON_RESULT: ${JSON_RESULT}"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"completed\", \"finding\": false}")
elif [ ${CLAM_RETURN_CODE} -eq 1 ]; then
  findings=$(cat ${LOGFILE} | grep FOUND | sed "s#${IMAGE_TAR_PATH}##")
  infoText="Potential malware found in ${IMAGE_BY_HASH}\nPlease take a look at ${findings}"
  echo "${infoText}"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"completed\", \"finding\": true, \"infoText\": \"${infoText}\"}")

  #cp /clusterscanner/malware.csv "${ARTIFACTS_PATH}/malware.csv"
  cp /clusterscanner/malware.json "${ARTIFACTS_PATH}/malware.json"
  sanitizedInfoText=$(echo ${infoText} | tr -d '|')

  jq \
    --arg infotext   "${sanitizedInfoText}" \
    --arg references "${ARTIFACTS_PATH}" 

  sed -i "s|###INFOTEXT###|${sanitizedInfoText}|" "${ARTIFACTS_PATH}/malware.csv"
  sed -i "s~###References###~~" "${ARTIFACTS_PATH}/malware.csv"
else
  infoText="Malware exited with the unexpected code ${CLAM_RETURN_CODE} in ${IMAGE_BY_HASH}, log: ${LOGFILE}"
  echo "${infoText}"
  cat "${LOGFILE}"
  JSON_RESULT=$(echo "${JSON_RESULT}" | jq -Sc ". += {\"status\": \"failed\", \"infoText\": \"${infoText}\"}")
fi

scan_result_post

#if [ ${CLAM_RETURN_CODE} -eq 2 ]; then
#  exit 2
#fi
exit ${CLAM_RETURN_CODE}
