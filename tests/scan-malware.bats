#!/usr/bin/env bats 

bats_require_minimum_version 1.5.0

load "${BATS_TEST_DIRNAME}/../images/base/scan-common.bash"

setup_file () {
    export FRESHCLAM_DATA_DIR=$(mktemp -d)
    FRESHCLAMCONF="${FRESHCLAM_DATA_DIR}/freshclam.conf"

    echo "DatabaseMirror db.de.clamav.net" > "$FRESHCLAMCONF"
    
    freshclam --config-file="$FRESHCLAMCONF" --datadir="$FRESHCLAM_DATA_DIR"
}

teardown_file () {
    rm -rf "$FRESHCLAM_DATA_DIR"
}

setup () {
    TEST_IMAGE_LOCATION=$(realpath test-image.tar)
    TEST_IMAGE_HASH="066b4af1f7fb365d2475baadf4ec42446eff11a56a3c8f7f7e4bcb2e7b58b649"
    TEST_ARTIFACTS_PATH=$(mktemp -d)
    MODULE_PATH=$(realpath "${BATS_TEST_DIRNAME}/../images/scan/malware")

    MODULE_NAME="malware_scan"
    IS_SCAN="true"

    source () {
        return 0;
    }

    scan_result_pre () {
        return 0;
    }
    scan_result_post () {
        return 0;
    }

    clamscan () {
        command clamscan -d "$FRESHCLAM_DATA_DIR" "$@"
    }
}

teardown() {
    rm -rf "$TEST_ARTIFACTS_PATH"
}

@test "test" {
    >&3 echo "$MODULE_PATH"
    cd "$MODULE_PATH"
    run -2 builtin source module.bash -i $TEST_IMAGE_HASH -t $TEST_IMAGE_LOCATION -a $TEST_ARTIFACTS_PATH
}
